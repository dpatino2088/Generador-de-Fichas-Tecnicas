<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portal de fichas técnicas</title>
    <style>
      :root {
        font-family: "Helvetica Neue", Arial, sans-serif;
        color: #222;
        font-size: 12px;
        background: #ececec;
        --page-width: 21.59cm; /* Carta */
        --page-height: 27.94cm;
        --page-margin: 1.5cm;
        --render-size: calc((var(--page-width) - var(--page-margin) * 2) * 0.245);
        --meta-height: calc(4mm + 2mm);
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
      }

      @media print {
        @page {
          size: Letter;
          margin: 0;
        }
        body {
          background: #fff;
        }
        .layout {
          padding: 0;
        }
        .sheet {
          width: calc(var(--page-width) - var(--page-margin) * 2);
          margin: 0 auto 16px;
          padding: var(--page-margin);
          box-shadow: none;
          page-break-after: always;
        }
        .sheet:last-child {
          page-break-after: auto;
        }
      }

      header {
        background: #111;
        color: #fff;
        padding: 20px 32px;
      }

      header h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      header p {
        margin: 6px 0 0;
        color: #cfcfcf;
        font-size: 0.95rem;
      }

      .layout {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 24px;
        padding: 24px 32px 48px;
      }

      .panel {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        padding: 16px 24px 32px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
      }

      .panel h2 {
        margin-top: 0;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin: 28px 0 12px;
      }

      .section-header:first-of-type {
        margin-top: 0;
      }

      .section-header h2 {
        margin: 0;
      }

      .reset-btn {
        background: #f4f4f4;
        color: #111;
        border: 1px solid #cfcfcf;
        border-radius: 4px;
        font-size: 0.7rem;
        padding: 6px 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
      }

      .reset-btn:hover {
        background: #e5e5e5;
      }

      .tab-bar {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
        margin: 0 0 20px;
        padding: 0;
        position: sticky;
        top: 0;
        z-index: 2;
        background: #fff;
      }

      .tab-button {
        border: 1px solid #cfcfcf;
        background: #fafafa;
        color: #555;
        padding: 12px;
        border-radius: 10px;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
      }

      .tab-button.active {
        background: #111;
        color: #fff;
        border-color: #111;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
      }

      .section {
        display: none;
      }

      .section.active {
        display: block;
        background: #fff;
        border-radius: 0 0 12px 12px;
        padding: 24px 0 0;
        animation: pageSwap 0.25s ease;
      }

      @keyframes pageSwap {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      label {
        display: block;
        font-size: 0.8rem;
        color: #555;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      input[type="text"],
      input[type="number"],
      input[type="file"],
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #c9c9c9;
        border-radius: 4px;
        font-size: 0.95rem;
        margin-bottom: 12px;
      }

      textarea {
        resize: vertical;
        min-height: 80px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }

      button,
      .btn-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        background: #111;
        color: #fff;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        cursor: pointer;
      }

      .btn-secondary {
        background: #555;
      }

      .repeatable {
        border: 1px solid #dcdcdc;
        padding: 16px;
        border-radius: 6px;
        margin-bottom: 12px;
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .repeatable button.remove {
        position: static;
        align-self: flex-end;
        padding: 4px 10px;
        background: #f6dcdc;
        color: #b30000;
        font-size: 0.7rem;
        border-radius: 4px;
      }

      .color-group {
        margin-top: 16px;
      }

      .preview-wrapper {
        padding: 24px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        overflow: auto;
        background: #f6f6f6;
      }

      .sheet {
        width: min(100%, calc(var(--page-width) - var(--page-margin) * 2));
        max-width: calc(var(--page-width) - var(--page-margin) * 2);
        margin: 0 auto 16px;
        background: #fff;
        padding: var(--page-margin);
        box-shadow: 0px 8px 30px rgba(0, 0, 0, 0.08);
        font-size: 0.92rem;
        line-height: 1.4;
      }

      .sheet header h1,
      .sheet header p {
        margin: 0;
      }

      .sheet header,
      .sheet .meta-bar,
      .sheet .product-name,
      .sheet .last-update,
      .sheet .code-box,
      .sheet .description,
      .sheet .split,
      .sheet .tech-grid,
      .sheet table,
      .sheet .icon-row,
      .sheet .photometry,
      .sheet .diagram,
      .sheet .notes {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      .sheet header {
        background: none;
        color: inherit;
        padding: 0;
        margin-bottom: 10px;
      }

      .sheet .sheet-header {
        display: grid;
        grid-template-columns: max(180px, calc((var(--page-width) - var(--page-margin) * 2) / 3)) 1fr;
        grid-template-rows: 1fr auto;
        align-items: stretch;
        margin-bottom: 24px;
      }

      .sheet .photo-wrapper {
        width: 100%;
        max-width: var(--render-size);
        aspect-ratio: 1 / 1;
        background: #e0e0e0;
        border: 1px solid #bcbcbc;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        justify-self: flex-start;
      }

      .sheet .photo-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .sheet .header-right {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        gap: 12px;
      }

      .sheet .logo-wrapper {
        display: flex;
        justify-content: flex-end;
        align-items: flex-start;
      }

      .sheet .meta-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.6cm;
        background: #111;
        color: #fff;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.06em;
        padding: 0 0.8cm;
        min-height: var(--meta-height);
        text-transform: uppercase;
        border-top: 1px solid #111;
        grid-column: 1 / -1;
        grid-row: 2 / 3;
        align-self: start;
        width: calc(100% - var(--render-size));
        margin-left: var(--render-size);
        margin-top: calc(-1 * var(--meta-height));
      }

      .sheet .meta-bar span {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
      }

      .meta-code {
        margin-left: auto;
      }

      .summary-table tr + tr td {
        border-top: 1px solid #e2e2e2;
        padding-top: 6px;
      }

      .sheet .logo-block,
      .sheet .logo-placeholder {
        width: 152px;
        height: 102px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
      }

      .sheet .logo-block {
        background: #fff;
      }

      .sheet .logo-placeholder {
        background: transparent;
      }

      .sheet .logo-block img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .sheet .product-name {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 2px 0;
      }

      .sheet .product-brand {
        font-size: 0.95rem;
        color: #555;
        margin-bottom: 4px;
      }

      .sheet .last-update,
      .sheet .code-box,
      .sheet .description,
      .sheet .split,
      .sheet table,
      .sheet .icon-row,
      .sheet .photometry,
      .sheet .diagram,
      .sheet .notes {
        margin-bottom: 14px;
      }

      .sheet .description {
        text-align: justify;
        line-height: 1.45;
      }

      .sheet .split {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .sheet h2 {
        font-size: 0.85rem;
        letter-spacing: 0.04em;
        color: #111;
        margin: 16px 0 6px;
        padding-bottom: 3px;
        border-bottom: 2px solid #111;
      }

      .sheet table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      .sheet table th,
      .sheet table td {
        border-bottom: 1px solid #e2e2e2;
        padding: 7px 4px;
        text-align: left;
      }

      .sheet table th {
        text-transform: uppercase;
        font-size: 0.72rem;
        color: #222;
        font-weight: 600;
      }

      .sheet table td {
        font-size: 0.82rem;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .summary-table td {
        white-space: normal;
        overflow: visible;
        text-overflow: unset;
      }
      .sheet .tech-grid {
        display: flex;
        gap: 20px;
        flex-wrap: nowrap;
        align-items: flex-start;
        margin-bottom: 14px;
      }

      .sheet .tech-grid table {
        width: calc(50% - 10px);
        font-size: 0.9rem;
        min-width: 0;
      }

      .tech-table {
        width: 100%;
        table-layout: fixed;
      }

      .tech-table col.col-field {
        width: 50%;
      }

      .tech-table col.col-value {
        width: 30%;
      }

      .tech-table col.col-unit {
        width: 20%;
      }


      .sheet .tech-grid table.full-width {
        width: 100%;
      }

      .sheet .icon-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        border-bottom: 1px solid #e2e2e2;
        padding: 12px 0 18px;
      }

      .sheet .icon {
        width: 60px;
        height: 50px;
        border: 1px solid #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.78rem;
      }

      .sheet .photometry {
        display: flex;
        gap: 24px;
        border-bottom: 1px solid #e2e2e2;
        padding: 14px 0;
        align-items: center;
        flex-wrap: wrap;
      }

      .sheet .photometry img {
        flex: 0 0 calc((var(--page-width) - var(--page-margin) * 2) / 3);
        max-width: calc((var(--page-width) - var(--page-margin) * 2) / 3);
        width: 100%;
        height: auto;
        object-fit: contain;
      }

      .sheet .diagram {
        display: flex;
        justify-content: flex-start;
        padding: 8px 0 4px;
      }

      .sheet .diagram img {
        max-width: calc((var(--page-width) - var(--page-margin) * 2) * 0.2333);
        width: 100%;
        height: auto;
        object-fit: contain;
      }

      .actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin: 16px 32px 32px;
      }


      @media (max-width: 1000px) {
        .sheet .tech-grid {
          flex-wrap: wrap;
        }
        .sheet .tech-grid table {
          width: 100%;
        }
      }
      @media (max-width: 1200px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .panel {
          max-height: none;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Portal de fichas técnicas</h1>
      <p>Rellena los campos y exporta un PDF único por luminaria.</p>
    </header>

    <div class="layout">
      <div class="panel" id="formPanel">
        <div class="tab-bar">
          <button type="button" class="tab-button active" data-target="general">Datos generales</button>
          <button type="button" class="tab-button" data-target="fotos">IMÁGENES</button>
          <button type="button" class="tab-button" data-target="configuraciones">Configuraciones</button>
          <button type="button" class="tab-button" data-target="iconos">Certificaciones</button>
          <button type="button" class="tab-button" data-target="tecnicos">Datos técnicos</button>
          <button type="button" class="tab-button" data-target="notas">Notas finales</button>
        </div>

        <div class="section active" data-section-content="general">
          <div class="section-header">
            <h2>Datos generales</h2>
            <button type="button" class="reset-btn" data-section="general">Reset</button>
          </div>
          <label for="productName">Nombre del producto</label>
          <input type="text" id="productName" placeholder="Ingresar dato" />

          <div class="grid-2">
            <div>
              <label for="brand">Marca / Línea</label>
              <input type="text" id="brand" placeholder="Ingresar dato" />
            </div>
            <div>
              <label for="code">Código / Referencia</label>
              <input type="text" id="code" placeholder="Ingresar dato" />
            </div>
          </div>

          <label for="lastUpdate">Última actualización</label>
          <input type="text" id="lastUpdate" placeholder="Ingresar dato" />

          <label for="codeDescription">Descripción corta</label>
          <input type="text" id="codeDescription" placeholder="Ingresar dato" />

          <label for="description">Descripción comercial / técnica</label>
          <textarea id="description" placeholder="Ingresar dato"></textarea>

          <div class="grid-2">
            <div>
              <label for="montaje">Montaje</label>
              <select id="montaje">
                <option value="">Selecciona una opción</option>
                <option>Downlights</option>
                <option>Spotlights</option>
                <option>Wall / Ceiling</option>
                <option>Suspension</option>
                <option>In-Ground</option>
                <option>Table / Floor</option>
                <option>Systems</option>
              </select>
            </div>
            <div>
              <label for="equipo">Equipo</label>
              <input type="text" id="equipo" placeholder="Ingresar dato" />
            </div>
          </div>
          <div class="grid-3">
            <div>
              <label for="ancho">Ancho (mm)</label>
              <input type="number" id="ancho" placeholder="-" />
            </div>
            <div>
              <label for="alto">Alto (mm)</label>
              <input type="number" id="alto" placeholder="-" />
            </div>
            <div>
              <label for="fondo">Fondo (mm)</label>
              <input type="number" id="fondo" placeholder="-" />
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label for="peso">Peso (kg)</label>
              <input type="number" step="0.01" id="peso" placeholder="-" />
            </div>
          </div>

          <div class="color-group">
            
            <div class="section-header">
              <h3>Colores</h3>
              <button type="button" class="btn-secondary" id="addColorGeneral">Agregar color</button>
            </div>
            <div id="colorContainer"></div>
          </div>
        </div>

        <div class="section" data-section-content="fotos">
          <div class="section-header">
            <h2>IMÁGENES</h2>
            <button type="button" class="reset-btn" data-section="fotos">Reset</button>
          </div>
          <label for="photoInput">Imagen</label>
          <input type="file" id="photoInput" accept="image/*" />

          <label for="logoInput">Logo</label>
          <input type="file" id="logoInput" accept="image/*" />

          <label for="diagramInput">Fotometría</label>
          <input type="file" id="diagramInput" accept="image/*" />
        </div>

        <div class="section" data-section-content="configuraciones">
          <div class="section-header">
            <h2>Configuraciones</h2>
            <button type="button" class="reset-btn" data-section="configuraciones">Reset</button>
          </div>
          <div id="configContainer"></div>
          <button type="button" id="addConfig">Agregar configuración</button>
        </div>

        

        <div class="section" data-section-content="iconos">
          <div class="section-header">
            <h2>Certificaciones</h2>
            <button type="button" class="reset-btn" data-section="iconos">Reset</button>
          </div>
          <label for="iconList">Escribe cada código separado por coma (IP20, IP40, CE...)</label>
          <input type="text" id="iconList" placeholder="Ingresar dato" />
        </div>

        <div class="section" data-section-content="tecnicos">
          <div class="section-header">
            <h2>Datos técnicos</h2>
            <button type="button" class="reset-btn" data-section="tecnicos">Reset</button>
          </div>
          <div id="techContainer"></div>
          <button type="button" id="addTechRow" class="btn-secondary">Agregar fila</button>
        </div>

        <div class="section" data-section-content="notas">
          <div class="section-header">
            <h2>Notas finales</h2>
            <button type="button" class="reset-btn" data-section="notas">Reset</button>
          </div>
          <label for="controlNotes">Notas de control</label>
          <textarea id="controlNotes" rows="3" placeholder="Ingresar dato"></textarea>

          <label for="footerNote">Nota legal / pie</label>
          <input type="text" id="footerNote" placeholder="Ingresar dato" />
        </div>
      </div>

      <div class="panel preview-wrapper">
        <div id="preview"></div>
      </div>
    </div>

    <div class="actions">
      <button id="exportButton">Exportar PDF</button>
      <button class="btn-secondary" id="printButton">Imprimir</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
      const defaultData = {
        productName: "",
        brand: "",
        lastUpdate: "",
        code: "",
        codeDescription:
          "",
        description:
          "",
        montaje: "",
        equipo: "",
        peso: "",
        ancho: "",
        alto: "",
        fondo: "",
        iconList: "",
        photoDataUrl: "",
        diagramDataUrl: "",
        logoDataUrl: "",
        controlNotes:
          "",
        footerNote:
          "",
        configuraciones: [
          {
            codigo: "",
            descripcion: "",
            componente: "",
          },
        ],
        colores: [
          { nombre: "", codigo: "" },
        ],
        datosTecnicos: [
          { campo: "lm de sistema", valor: "0", unidad: "lm" },
          { campo: "Temperatura de color", valor: "0", unidad: "K" },
          { campo: "W de sistema", valor: "0", unidad: "W" },
          { campo: "MacAdam Step", valor: "0", unidad: "SDCM" },
          { campo: "lm de la fuente", valor: "0", unidad: "lm" },
          { campo: "Vida útil LED", valor: ">50,000h L80 B10", unidad: "h" },
          { campo: "W de la fuente", valor: "0", unidad: "W" },
          { campo: "Eficiencia luminosa", valor: "0", unidad: "lm/W" },
          { campo: "lm en modo emergencia", valor: "0", unidad: "lm" },
          { campo: "Flujo emisión > 90°", valor: "0", unidad: "lm" },
          { campo: "Light Output Ratio (L.O.R.)", valor: "0", unidad: "%" },
          { campo: "Control", valor: "On/Off", unidad: "-" },
          { campo: "CRI (mínimo)", valor: "0", unidad: "Ra" },
        ],
      };

      const state = {
        photoDataUrl: "",
        diagramDataUrl: "",
        logoDataUrl: "",
      };

      const setFieldValue = (id, value = "") => {
        const input = document.getElementById(id);
        if (input) input.value = value ?? "";
      };

      const generalFieldIds = [
        "productName",
        "brand",
        "lastUpdate",
        "code",
        "codeDescription",
        "description",
              "montaje",
        "equipo",
        "ancho",
        "alto",
        "fondo",
        "peso",
      ];

      const formIds = [
        "productName",
        "brand",
        "lastUpdate",
        "code",
        "codeDescription",
        "description",
              "montaje",
        "equipo",
        "peso",
        "iconList",
        "ancho",
        "alto",
        "fondo",
        "controlNotes",
        "footerNote",
      ];

      const configContainer = document.getElementById("configContainer");
      const colorContainer = document.getElementById("colorContainer");
      const techContainer = document.getElementById("techContainer");
      const tabButtons = document.querySelectorAll(".tab-button");
      const sectionBlocks = document.querySelectorAll("[data-section-content]");

      const activateSection = (targetId) => {
        sectionBlocks.forEach((section) => {
          section.classList.toggle(
            "active",
            section.dataset.sectionContent === targetId
          );
        });
        tabButtons.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.target === targetId);
        });
      };

      const addConfigRow = (config = { codigo: "", descripcion: "", componente: "" }) => {
        const wrapper = document.createElement("div");
        wrapper.className = "repeatable";
        wrapper.dataset.configRow = "true";
        wrapper.innerHTML = `
          <div class="grid-3">
            <div>
              <label>Código</label>
              <input type="text" class="cfg-codigo" placeholder="-" value="${config.codigo}" />
            </div>
            <div>
              <label>Descripción</label>
              <input type="text" class="cfg-descripcion" placeholder="-" value="${config.descripcion}" />
            </div>
            <div>
              <label>Componente</label>
              <input type="text" class="cfg-estado" placeholder="-" value="${config.componente || ""}" />
            </div>
          </div>
          <button type="button" class="remove">Eliminar</button>`;
        wrapper.querySelector(".remove").addEventListener("click", () => {
          wrapper.remove();
          updatePreview();
        });
        wrapper.querySelectorAll("input").forEach((input) =>
          input.addEventListener("input", updatePreview)
        );
        configContainer.appendChild(wrapper);
      };

      const addColorRow = (color = { nombre: "", codigo: "" }) => {
        const wrapper = document.createElement("div");
        wrapper.className = "repeatable";
        wrapper.dataset.colorRow = "true";
        wrapper.innerHTML = `
          <div class="grid-2">
            <div>
              <label>Nombre</label>
              <input type="text" class="color-nombre" value="${color.nombre}" />
            </div>
            <div>
              <label>Código</label>
              <input type="text" class="color-codigo" value="${color.codigo}" />
            </div>
          </div>
          <button type="button" class="remove">Eliminar</button>`;
        wrapper.querySelector(".remove").addEventListener("click", () => {
          wrapper.remove();
          updatePreview();
        });
        wrapper.querySelectorAll("input").forEach((input) =>
          input.addEventListener("input", updatePreview)
        );
        colorContainer.appendChild(wrapper);
      };

      const addTechRow = (row = { campo: "", valor: "", unidad: "" }) => {
        const wrapper = document.createElement("div");
        wrapper.className = "repeatable";
        wrapper.dataset.techRow = "true";
        wrapper.innerHTML = `
          <div class="grid-3">
            <div>
              <label>Campo</label>
              <input type="text" class="tech-campo" value="${row.campo}" readonly />
            </div>
            <div>
              <label>Valor</label>
              <input type="text" class="tech-valor" placeholder="-" value="${row.valor || ""}" />
            </div>
            <div>
              <label>Unidad</label>
              <input type="text" class="tech-unidad" value="${row.unidad}" readonly />
            </div>
          </div>
          <button type="button" class="remove">Eliminar</button>`;
        wrapper.querySelector(".remove").addEventListener("click", () => {
          wrapper.remove();
          updatePreview();
        });
        wrapper.querySelectorAll("input").forEach((input) =>
          input.addEventListener("input", updatePreview)
        );
        techContainer.appendChild(wrapper);
      };

      const handleFile = (input, key) => {
        if (!input.files.length) {
          state[key] = "";
          updatePreview();
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          state[key] = e.target.result;
          updatePreview();
        };
        reader.readAsDataURL(input.files[0]);
      };

      document.getElementById("photoInput").addEventListener("change", (e) =>
        handleFile(e.target, "photoDataUrl")
      );
      document.getElementById("diagramInput").addEventListener("change", (e) =>
        handleFile(e.target, "diagramDataUrl")
      );
      document.getElementById("logoInput").addEventListener("change", (e) =>
        handleFile(e.target, "logoDataUrl")
      );

      document.getElementById("addConfig").addEventListener("click", () => addConfigRow());
      document.getElementById("addColorGeneral").addEventListener("click", () => addColorRow());
      document.getElementById("addTechRow").addEventListener("click", () => addTechRow());

      const renderFicha = (data) => {
        const iconHtml = data.iconos
          .map((icon) => `<div class="icon">${icon}</div>`)
          .join("");
        const configRows = data.configuraciones
          .map(
            (cfg) => `
            <tr>
              <td>${cfg.codigo}</td>
              <td>${cfg.descripcion}</td>
              <td>${cfg.componente || ""}</td>
            </tr>`
          )
          .join("");
        const colorText = (data.colores.length
          ? data.colores.map((color) => `${(color.nombre || "Ingresar dato").trim()}${color.codigo ? ` (${color.codigo})` : ""}`)
          : ["Ingresar dato"]);

        const formatText = (value) => (value && value.trim().length ? value : "Ingresar dato");
        const optionalText = (value) => (value && value.trim().length ? value.trim() : "");

        const photoSrc = data.photo || "";
        const diagramSrc = data.diagram || "";
        const displayBrand = formatText(data.brand);
        const displayProductName = formatText(data.productName);
        const displayLastUpdate = formatText(data.lastUpdate);
        const displayCode = formatText(data.code);
        const displayCodeDescription = formatText(data.codeDescription);
        const displayDescription = formatText(data.description);
        const displayMontaje = formatText(data.montaje);
        const displayEquipo = formatText(data.equipo);
        const controlNoteText = optionalText(data.controlNotes);
        const footerNoteText = optionalText(data.footerNote);
        const primaryCodeRaw = data.code ? data.code.split(" - ")[0] || data.code : "";
        const displayPrimaryCode = formatText(primaryCodeRaw);
        const dimensionText = `${data.ancho || "-"} W × ${data.alto || "-"} H × ${data.fondo || "-"} D mm`;
        const weightText = data.peso ? `${data.peso} kg` : "-";

        const techMid = Math.ceil(data.datosTecnicos.length / 2);
        const leftTech = data.datosTecnicos.slice(0, techMid);
        const rightTech = data.datosTecnicos.slice(techMid);

        const renderTechTable = (items, fullWidth = false) => `
          <table class="tech-table${fullWidth ? " full-width" : ""}">
            <colgroup>
              <col class="col-field" />
              <col class="col-value" />
              <col class="col-unit" />
            </colgroup>
            <thead>
              <tr>
                <th>Campo</th>
                <th>Valor</th>
                <th>Unidad</th>
              </tr>
            </thead>
            <tbody>
              ${
                items
                  .map(
                    (row) => `
                <tr>
                  <td>${row.campo}</td>
                  <td>${row.valor}</td>
                  <td>${row.unidad}</td>
                </tr>`
                  )
                  .join("") || "<tr><td colspan='3'></td></tr>"
              }
            </tbody>
          </table>`;

        return `
          <div class="sheet preview-sheet">
            <div class="sheet-header">
              <div class="photo-wrapper">
                ${photoSrc ? `<img src="${photoSrc}" alt="Imagen del producto" />` : "Render principal"}
              </div>
              <div class="header-right">
                <div class="logo-wrapper">
                  ${
                    data.logo
                      ? `<div class="logo-block"><img src="${data.logo}" alt="Logo" /></div>`
                      : ""
                  }
                </div>
              </div>
              <div class="meta-bar">
                <span class="meta-code">Código: ${displayPrimaryCode}</span>
              </div>
            </div>

            <div class="product-name">${displayProductName}</div>
            <div class="product-brand">${displayBrand}</div>
            <div class="last-update">Última actualización: ${displayLastUpdate}</div>

            <h2>Configuraciones del producto</h2>
            <table>
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Descripción</th>
                  <th>Componente</th>
                </tr>
              </thead>
              <tbody>
                ${configRows || "<tr><td colspan='3'>Sin configuraciones</td></tr>"}
              </tbody>
            </table>

            <div class="code-box">
              <div><strong>Código producto:</strong> ${displayCode}</div>
              <div><strong>Descripción corta:</strong> ${displayCodeDescription}</div>
            </div>

            <h2>Descripción</h2>
            <div class="description">${displayDescription}</div>

            <h2>Datos generales</h2>
            <div class="split data-summary">
              <table class="mini-table summary-table">
                <thead>
                  <tr>
                    <th>Dimensiones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${dimensionText}</td>
                  </tr>
                  <tr>
                    <td>Peso: ${weightText}</td>
                  </tr>
                </tbody>
              </table>
              <table class="mini-table summary-table">
                <thead>
                  <tr>
                    <th>Colores</th>
                  </tr>
                </thead>
                <tbody>
                  ${colorText.length
                    ? colorText.map((c) => `<tr><td>${c}</td></tr>`).join("")
                    : `<tr><td>Ingresar dato</td></tr>`}
                </tbody>
              </table>
              <table class="mini-table summary-table">
                <thead>
                  <tr>
                    <th>Montaje</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${displayMontaje}</td>
                  </tr>
                </tbody>
              </table>
              <table class="mini-table summary-table">
                <thead>
                  <tr>
                    <th>Equipo</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${displayEquipo}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <h2>Datos técnicos</h2>
            <div class="tech-grid">
              ${renderTechTable(leftTech, rightTech.length === 0)}
              ${rightTech.length ? renderTechTable(rightTech) : ""}
            </div>
            ${controlNoteText ? `<div class="notes">${controlNoteText}</div>` : ""}

            ${
              diagramSrc
                ? `<h2>Fotometría</h2>
            <div class="diagram">
              <img src="${diagramSrc}" alt="Diagrama" />
            </div>`
                : ""
            }

            <h2>Certificaciones</h2>
            <div class="icon-row">${iconHtml}</div>
            ${footerNoteText ? `<div class="footer-note">${footerNoteText}</div>` : ""}
          </div>`;
      };

      const collectRepeatable = (selector, mapFn) =>
        Array.from(document.querySelectorAll(selector))
          .map(mapFn)
          .filter((row) => Object.values(row).some((value) => value));

      const updatePreview = () => {
        const data = {};
        formIds.forEach((id) => {
          const input = document.getElementById(id);
          data[id] = input ? input.value : "";
        });

        data.configuraciones = collectRepeatable("[data-config-row]", (row) => ({
          codigo: row.querySelector(".cfg-codigo").value,
          descripcion: row.querySelector(".cfg-descripcion").value,
          componente: row.querySelector(".cfg-estado").value,
        }));

        data.colores = collectRepeatable("[data-color-row]", (row) => ({
          nombre: row.querySelector(".color-nombre").value,
          codigo: row.querySelector(".color-codigo").value,
        }));

        data.iconos = (data.iconList || "")
          .split(",")
          .map((i) => i.trim())
          .filter(Boolean);

        data.datosTecnicos = collectRepeatable("[data-tech-row]", (row) => ({
          campo: row.querySelector(".tech-campo").value,
          valor: (() => {
            const raw = row.querySelector(".tech-valor").value.trim();
            return raw === "" ? "-" : raw;
          })(),
          unidad: row.querySelector(".tech-unidad").value,
        }));

        data.photo = state.photoDataUrl;
        data.diagram = state.diagramDataUrl;
        data.logo = state.logoDataUrl;

        document.getElementById("preview").innerHTML = renderFicha(data);
      };

      const loadDefaults = () => {
        formIds.forEach((id) => {
          const input = document.getElementById(id);
          if (input) input.value = defaultData[id] ?? "";
        });
        state.photoDataUrl = defaultData.photoDataUrl || "";
        state.diagramDataUrl = defaultData.diagramDataUrl || "";
        state.logoDataUrl = defaultData.logoDataUrl || "";
        defaultData.configuraciones.forEach((cfg) => addConfigRow(cfg));
        defaultData.colores.forEach((color) => addColorRow(color));
        defaultData.datosTecnicos.forEach((row) => addTechRow(row));
        updatePreview();
      };

      document.querySelectorAll("input, textarea").forEach((el) => {
        el.addEventListener("input", updatePreview);
      });

      document.querySelectorAll("select").forEach((el) => {
        el.addEventListener("change", updatePreview);
      });

      tabButtons.forEach((btn) =>
        btn.addEventListener("click", () => activateSection(btn.dataset.target))
      );

      document.querySelectorAll(".reset-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const section = btn.dataset.section;
          switch (section) {
            case "general":
              generalFieldIds.forEach((id) => setFieldValue(id, defaultData[id] ?? ""));
              colorContainer.innerHTML = "";
              if (defaultData.colores && defaultData.colores.length) {
                defaultData.colores.forEach((color) => addColorRow(color));
              } else {
                addColorRow();
              }
              break;
            case "fotos":
              state.photoDataUrl = defaultData.photoDataUrl || "";
              state.diagramDataUrl = defaultData.diagramDataUrl || "";
              state.logoDataUrl = defaultData.logoDataUrl || "";
              document.getElementById("photoInput").value = "";
              document.getElementById("diagramInput").value = "";
              document.getElementById("logoInput").value = "";
              break;
            case "configuraciones":
              configContainer.innerHTML = "";
              defaultData.configuraciones.forEach((cfg) => addConfigRow(cfg));
              break;
            case "iconos":
              setFieldValue("iconList", defaultData.iconList || "");
              break;
            case "tecnicos":
              techContainer.innerHTML = "";
              defaultData.datosTecnicos.forEach((row) => addTechRow(row));
              break;
            case "notas":
              setFieldValue("controlNotes", defaultData.controlNotes || "");
              setFieldValue("footerNote", defaultData.footerNote || "");
              break;
            default:
              break;
          }
          updatePreview();
        });
      });

      const getPageMarginPoints = () => {
        const raw = getComputedStyle(document.documentElement)
          .getPropertyValue("--page-margin")
          .trim();
        const match = raw.match(/([\d.]+)\s*(cm|mm|in|pt)?/i);
        if (!match) return 70.87;
        const value = parseFloat(match[1]);
        const unit = (match[2] || "cm").toLowerCase();
        const unitToPoints = { cm: 28.3465, mm: 2.83465, in: 72, pt: 1 };
        return value * (unitToPoints[unit] || 28.3465);
      };

      const exportPDF = async () => {
        const sheet = document.querySelector(".preview-sheet");
        if (!sheet) return;
        const canvas = await html2canvas(sheet, { scale: 2, scrollY: -window.scrollY });
        const imageData = canvas.toDataURL("image/png");

        const pdf = new jspdf.jsPDF("p", "pt", "letter");
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 42.52; // 1.5 cm
        const printableWidth = pageWidth - margin * 2;
        const printableHeight = pageHeight - margin * 2;
        const scale = printableWidth / canvas.width;
        const pageHeightPx = printableHeight / scale;
        let position = 0;

        while (position < canvas.height) {
          const sliceCanvas = document.createElement("canvas");
          const sliceHeight = Math.min(pageHeightPx, canvas.height - position);
          if (sliceHeight <= 0) {
            break;
          }
          sliceCanvas.width = canvas.width;
          sliceCanvas.height = sliceHeight;
          const sliceCtx = sliceCanvas.getContext("2d");
          sliceCtx.fillStyle = "#ffffff";
          sliceCtx.fillRect(0, 0, sliceCanvas.width, sliceCanvas.height);
          sliceCtx.drawImage(
            canvas,
            0,
            position,
            canvas.width,
            sliceHeight,
            0,
            0,
            canvas.width,
            sliceHeight
          );
          const sliceData = sliceCanvas.toDataURL("image/png");
          if (position > 0) {
            pdf.addPage();
          }
          pdf.addImage(
            sliceData,
            "PNG",
            margin,
            margin,
            printableWidth,
            sliceHeight * scale
          );
          position += sliceHeight;
        }

        const fileName = (document.getElementById("productName").value || "ficha")
          .toLowerCase()
          .replace(/\s+/g, "-");
        pdf.save(`${fileName}.pdf`);
      };

      document.getElementById("exportButton").addEventListener("click", exportPDF);
      document.getElementById("printButton").addEventListener("click", () => window.print());

      loadDefaults();
    </script>
  </body>
</html>

